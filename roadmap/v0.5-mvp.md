# v0.5: MVP

**Theme**: Spaces, branches, logging, and MCP. The minimum viable product.

Spaces give data a home. Fork/diff/merge makes branches useful. Structured logging makes debugging possible. The MCP server puts Strata in every AI agent's toolbox. Together, these complete the MVP.

Split into three sub-releases, each independently shippable:

| Sub-release | What ships |
|-------------|------------|
| [v0.5.1](#v051-spaces--structured-logging) | Spaces + structured logging |
| [v0.5.2](#v052-branch-operations) | Fork, diff, merge (space-aware) |
| [v0.5.3](#v053-mcp-server) | MCP server (exposes everything) |

---

## v0.5.1: Spaces + Structured Logging — **SHIPPED**

Infrastructure first. Spaces change the data model, logging makes debugging possible while building everything that follows.

### Spaces

An organizational layer within branches. Every branch contains one or more spaces, each with its own instance of every primitive.

```
strata/
├── main/
│   ├── default/          ← implicit, always exists
│   │   ├── kv/
│   │   ├── events/
│   │   ├── state/
│   │   ├── json/
│   │   └── vectors/
│   ├── conversations/
│   │   ├── kv/
│   │   ├── events/
│   │   └── ...
│   └── tool-results/
│       └── ...
```

**API:**

```rust
// All operations go to the "default" space unless set otherwise
let db = Strata::open(config)?;
db.kv_put("key", "value");                // writes to default/kv/key

// Switch to a named space (creates if new, selects if exists)
db.set_space("conversations");
db.kv_put("msg_001", payload);            // writes to conversations/kv/msg_001

// List and delete
db.list_spaces();                         // → ["default", "conversations", "tool-results"]
db.delete_space("tool-results");          // must be empty, or use force flag
```

**Design decisions (following established conventions):**

| Decision | Choice | Precedent |
|----------|--------|-----------|
| Each space owns its own primitives | Yes | Postgres schemas own their tables |
| Default space exists implicitly | Yes (`default`) | Postgres `public` schema |
| Nesting | No, flat | Postgres, MongoDB, MySQL |
| Operations | Create (via `set_space`), list, delete | Standard CRUD |
| Isolation | None — branch-level access covers all spaces | Postgres schemas within a database |
| Fork behavior | Copies all spaces | Postgres `CREATE DATABASE` copies all schemas |

**Concurrency note:** `set_space` is per-handle. With `Strata::new_handle()`, each thread gets its own active space. No cross-thread interference.

**Internal delimiter:** `/` separates space from key in storage (`conversations/msg_001`). This is internal only — users never see or type the delimiter. The space is context on the handle, the key is just the key.

**Future (post-MVP):** Move, copy, rename, per-space indexing. Not now.

### Structured Logging

`tracing` spans and events on key code paths, nothing more.

- `tracing` crate is already a workspace dependency
- Instrument: transaction lifecycle, WAL writes, snapshot creation, compaction, vector search, branch operations, space operations
- Configurable log levels per subsystem
- JSON log format option for structured consumption
- Off by default — zero overhead unless the caller wires up a subscriber

Not an observability platform. Just structured logs that make debugging possible.

---

## v0.5.2: Branch Operations

Fork, diff, and merge — now space-aware from the start.

### Branch Fork

Copy all data from one branch to a new branch. Foundation for A/B testing, experiment tracking, and safe exploration.

- Atomic copy across all spaces and all primitives within each space
- Source branch remains unchanged
- API: `db.fork_branch("source", "destination")`
- Stub exists: `crates/executor/src/api/branches.rs` (`fork()` returns `NotImplemented`)

### Branch Diff

Compare two branches across all spaces and primitives.

- Structured by space, then by primitive and key
- Summary counts and total changed objects
- Filterable by space, key prefix, event type, JSON path, or vector collection
- Returns `BranchDiff` with `only_in_first`, `only_in_second`, `different` fields
- API: `db.diff_branches("branch-a", "branch-b")`
- Engine infrastructure exists: `diff_views()` and `ReadOnlyView` in `crates/engine/src/recovery/replay.rs`

### Branch Merge

Apply changes from one branch into another.

- Deterministic conflict resolution: last-writer-wins (default) or strict error mode
- Atomic across all spaces and primitives
- Emits merge metadata: source branch, target branch, timestamp, conflict stats
- Depends on diff infrastructure (merge = diff + apply)
- API: `db.merge_branches("source", "target", MergeOptions)`

| Strategy | Behavior |
|----------|----------|
| `LastWriterWins` (default) | Source value overwrites target if both modified the same key |
| `Strict` | Return error listing all conflicts without modifying target |

---

## v0.5.3: MCP Server

Model Context Protocol server that exposes Strata as a tool provider for AI agents. stdin/stdout JSON-RPC transport.

- All primitives + spaces + branches + search as tools
- Space operations: `set_space`, `list_spaces`, `delete_space`
- Branch operations: create, switch, fork, diff, merge
- Read-only mode support via `strata-security`
- Validates the Command/Output serialization path end-to-end

### Tool definitions

Each public Strata method becomes an MCP tool:

```json
{
  "name": "kv_put",
  "description": "Store a key-value pair in the current space",
  "parameters": {
    "key": { "type": "string" },
    "value": { "type": "string" }
  }
}
```

Tools are grouped by category (primitives, spaces, branches) for discoverability.

### Package structure

```
sdks/mcp/
├── Cargo.toml          # depends on strata-executor, serde_json
├── src/
│   ├── main.rs         # stdio loop, JSON-RPC dispatch
│   ├── tools.rs        # MCP tool definitions
│   └── convert.rs      # MCP params <-> Command/Output mapping
└── tests/
    └── mcp_tests.rs
```

---

## Key files

| Area | Files |
|------|-------|
| Space storage | `crates/engine/src/space/` (new) |
| Space API | `crates/executor/src/api/spaces.rs` (new) |
| Branch API stubs | `crates/executor/src/api/branches.rs` |
| Diff infrastructure | `crates/engine/src/recovery/replay.rs` |
| Logging | `tracing` integration across crates |
| MCP | `sdks/mcp/` (new) |

## Dependencies

None — builds on shipped infrastructure.

## Open questions

- Should merge emit a "merge commit" event in the event log?
- Should merge be allowed to target the current active branch?
- Should `set_space` on a non-existent space auto-create it, or should create be explicit? (Current design: auto-create)
