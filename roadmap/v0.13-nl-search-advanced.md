# v0.13: Natural Language Search (Advanced)

**Theme**: Search that feels intelligent — query expansion, result summarization, multi-step retrieval.

v0.12 shipped NL→query decomposition. v0.13 makes Qwen3 do real work: expand queries to find more, summarize results into coherent answers, and chain retrieval steps when one search isn't enough.

---

## Query Expansion

Qwen3 broadens the original query to improve recall.

- Generate synonyms, related concepts, and alternative phrasings
- Example: "agent errors" → also search for "failures", "exceptions", "tool_call status=error"
- Expansion is transparent — the user sees what sub-queries were generated

## Result Summarization

Qwen3 synthesizes search results into a coherent response. Since Qwen3 runs at the edge (see [v0.12](./v0.12-nl-search-basic.md)), this requires a second round-trip: the client sends raw search results to the edge for summarization.

```
Client                              StrataHub Edge
    │                                    │
    ├── NL query ──────────────────►     │
    │                                    ├── Qwen3: decompose + expand
    │   ◄── sub-queries ───────────────┤
    │                                    │
    ├── Execute locally (hybrid search)  │
    │                                    │
    ├── Raw results ───────────────►     │
    │                                    ├── Qwen3: summarize
    │   ◄── structured summary ────────┤
    │                                    │
    └── Return to caller                 │
```

- Structured summaries, not freeform text
- Source attribution — every claim links back to the source result
- Configurable: users can opt out and get raw results (v0.12 behavior)

**Privacy note**: Summarization sends search results (not raw database contents, but matched excerpts and metadata) to the edge. For privacy-sensitive workloads using the local Qwen3 fallback (`intelligence-llm-local`), summarization runs entirely on-device.

## Multi-Step Retrieval (Limited)

Qwen3 chains search operations when one round isn't enough. Each step involves a client→edge→client round-trip: the edge generates the next sub-query based on previous results, the client executes it locally.

- Maximum 3 retrieval steps (bounded to prevent runaway)
- Each step's results inform the next step's query
- Example: "what happened after the agent failed?" →
  1. Edge: decompose → client: find failure events → send results to edge
  2. Edge: generate follow-up → client: find events after the failure timestamp → send results to edge
  3. Edge: generate follow-up → client: correlate with state changes
  4. Edge: summarize (if enabled)

### Guardrails

- Hard cap on retrieval steps (3)
- Hard cap on total results scanned per query
- Timeout per query to prevent Qwen3 from looping
- Maximum 2-4 edge round-trips per NL query (decompose + up to 3 follow-ups)

---

## Dependencies

- v0.12 (basic NL search — this extends the Qwen3 integration)
- StrataHub edge infrastructure (expansion, summarization, and multi-step retrieval all use edge inference)

## Open questions

- How aggressive should query expansion be? Too much = noise, too little = missed results
- Should multi-step retrieval be opt-in or default?
- How to present the retrieval chain to the user for transparency?
- Should the edge batch decomposition + expansion into a single inference call to reduce round-trips?
- For summarization, how much result data is acceptable to send to the edge? Should there be a size cap or redaction policy?
