Plan to implement                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ Plan: v0.5.2 Branch Operations (Fork, Diff, Merge)                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                                      │
│ Goal                                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                      │
│ Implement fork_branch, diff_branches, and merge_branches — replacing the existing NotImplemented stubs with working, space-aware implementations.                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ Architecture                                                                                                                                                                                                                                         │
│                                                                                                                                                                                                                                                      │
│ New crates/engine/src/branch_ops.rs module with three public functions, exposed through the executor's Branches power API and Strata convenience methods.                                                                                            │
│                                                                                                                                                                                                                                                      │
│ Follows the pattern established by bundle.rs — direct engine/database access with list_by_type scanning, NOT Command dispatch. Fork/diff/merge are compound operations that span multiple primitives and spaces, so they don't fit the               │
│ single-command pattern.                                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                                      │
│ Files to Create                                                                                                                                                                                                                                      │
│ ┌─────────────────────────────────┬─────────────────────────────────────────────────────────┐                                                                                                                                                        │
│ │              File               │                         Purpose                         │                                                                                                                                                        │
│ ├─────────────────────────────────┼─────────────────────────────────────────────────────────┤                                                                                                                                                        │
│ │ crates/engine/src/branch_ops.rs │ Engine-level fork, diff, merge functions + result types │                                                                                                                                                        │
│ └─────────────────────────────────┴─────────────────────────────────────────────────────────┘                                                                                                                                                        │
│ Files to Modify                                                                                                                                                                                                                                      │
│ ┌─────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────────┐                                                                                                                          │
│ │                File                 │                                      Changes                                      │                                                                                                                          │
│ ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────┤                                                                                                                          │
│ │ crates/engine/src/lib.rs            │ Add pub mod branch_ops; and re-export key types                                   │                                                                                                                          │
│ ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────┤                                                                                                                          │
│ │ crates/executor/src/api/branches.rs │ Replace fork/diff stubs with real implementations, add merge, redesign BranchDiff │                                                                                                                          │
│ ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────┤                                                                                                                          │
│ │ crates/executor/src/api/mod.rs      │ Add diff_branches(), merge_branches() convenience methods, update fork_branch()   │                                                                                                                          │
│ ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────┤                                                                                                                          │
│ │ tests/integration/branching.rs      │ Replace not_implemented tests, add comprehensive fork/diff/merge tests            │                                                                                                                          │
│ └─────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────┘                                                                                                                          │
│ Versioning Model                                                                                                                                                                                                                                     │
│                                                                                                                                                                                                                                                      │
│ Key insight: All writes go through db.transaction(branch_id, |txn| txn.put(key, value)). At commit time, a monotonic commit_version is allocated and each key is stored via store.put_with_version(key, value, commit_version, None). This means:    │
│                                                                                                                                                                                                                                                      │
│ - Fork: Source data is scanned at latest versions. When written to the destination, each transaction gets a fresh commit version. Version numbers are NOT preserved — they're re-assigned. The destination branch has its own version space.         │
│ - Merge: Same principle. Changes from source are applied as new writes to target. Each merge transaction gets a new commit version. The target branch's version chain grows naturally.                                                               │
│ - No version manipulation needed: We never call put_with_version directly. We use db.transaction() which handles version allocation, WAL, and validation automatically.                                                                              │
│                                                                                                                                                                                                                                                      │
│ This follows the same pattern as import_branch() in bundle.rs:246-261, which replays payloads via db.transaction() without preserving original versions.                                                                                             │
│                                                                                                                                                                                                                                                      │
│ Key Reference Files (read-only patterns to follow)                                                                                                                                                                                                   │
│ ┌────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────────┐                                                                                                                    │
│ │                        File                        │                                 Pattern                                  │                                                                                                                    │
│ ├────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                    │
│ │ crates/engine/src/bundle.rs:134-195                │ scan_branch_data() — scans all TypeTags for a branch, groups by version  │                                                                                                                    │
│ ├────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                    │
│ │ crates/engine/src/bundle.rs:210-272                │ import_branch() — replays data into a branch via db.transaction()        │                                                                                                                    │
│ ├────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                    │
│ │ crates/engine/src/recovery/replay.rs:295-479       │ Existing DiffEntry, BranchDiff, diff_views() (KV+Event only)             │                                                                                                                    │
│ ├────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                    │
│ │ crates/engine/src/primitives/space.rs:74-82        │ SpaceIndex::list(branch_id) — lists spaces in a branch                   │                                                                                                                    │
│ ├────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                    │
│ │ crates/storage/src/sharded.rs:659-679              │ list_by_type(branch_id, type_tag) — scans all keys of a type in a branch │                                                                                                                    │
│ ├────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                    │
│ │ crates/engine/src/primitives/branch/index.rs:42-50 │ resolve_branch_name() — converts name to BranchId                        │                                                                                                                    │
│ └────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────────┘                                                                                                                    │
│ ---                                                                                                                                                                                                                                                  │
│ Phase 1: Fork                                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                      │
│ Engine (branch_ops.rs)                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                      │
│ pub fn fork_branch(db: &Arc<Database>, source: &str, destination: &str) -> StrataResult<ForkInfo>                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ ForkInfo: { source: String, destination: String, keys_copied: u64, spaces_copied: u64 }                                                                                                                                                              │
│                                                                                                                                                                                                                                                      │
│ Implementation steps:                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                      │
│ 1. Verify source branch exists via BranchIndex::get_branch(source)                                                                                                                                                                                   │
│ 2. Verify destination doesn't exist via BranchIndex::exists(destination)                                                                                                                                                                             │
│ 3. Create destination branch via BranchIndex::create_branch(destination)                                                                                                                                                                             │
│ 4. Resolve both names to BranchId via resolve_branch_name()                                                                                                                                                                                          │
│ 5. List source spaces via SpaceIndex::list(source_branch_id), register each in destination via SpaceIndex::register(dest_branch_id, space)                                                                                                           │
│ 6. Scan all source data: iterate [TypeTag::KV, Event, State, Json, Vector, VectorConfig], call storage.list_by_type(&source_branch_id, tag) for each. Note: list_by_type returns latest (non-tombstone) values across ALL spaces — the space is      │
│ embedded in key.namespace.space                                                                                                                                                                                                                      │
│ 7. For each key/value found: clone the Key, replace namespace.branch_id with the destination's BranchId (preserving space, user_key, type_tag)                                                                                                       │
│ 8. Write via db.transaction(dest_branch_id, |txn| txn.put(new_key, value)). Group writes into batched transactions (e.g., one per space or one large transaction) for efficiency. New commit versions are auto-assigned — we don't preserve source   │
│ versions.                                                                                                                                                                                                                                            │
│ 9. Return ForkInfo with stats                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                      │
│ Executor (branches.rs)                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                      │
│ - Change fork(&self, _destination: &str) to fork(&self, source: &str, destination: &str)                                                                                                                                                             │
│ - Implementation: call branch_ops::fork_branch(&self.executor.primitives().db, source, destination)                                                                                                                                                  │
│ - Update Strata::fork_branch(destination) to pass self.current_branch.as_str() as source                                                                                                                                                             │
│                                                                                                                                                                                                                                                      │
│ ---                                                                                                                                                                                                                                                  │
│ Phase 2: Diff                                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                      │
│ Engine (branch_ops.rs)                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                      │
│ pub fn diff_branches(db: &Arc<Database>, branch_a: &str, branch_b: &str) -> StrataResult<BranchDiffResult>                                                                                                                                           │
│                                                                                                                                                                                                                                                      │
│ New types:                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                      │
│ pub struct DiffEntry {                                                                                                                                                                                                                               │
│     pub key: String,           // user key                                                                                                                                                                                                           │
│     pub primitive: PrimitiveType,                                                                                                                                                                                                                    │
│     pub space: String,                                                                                                                                                                                                                               │
│     pub value_a: Option<String>,  // stringified value in branch A                                                                                                                                                                                   │
│     pub value_b: Option<String>,  // stringified value in branch B                                                                                                                                                                                   │
│ }                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ pub struct SpaceDiff {                                                                                                                                                                                                                               │
│     pub space: String,                                                                                                                                                                                                                               │
│     pub added: Vec<DiffEntry>,    // in B but not A                                                                                                                                                                                                  │
│     pub removed: Vec<DiffEntry>,  // in A but not B                                                                                                                                                                                                  │
│     pub modified: Vec<DiffEntry>, // in both, different values                                                                                                                                                                                       │
│ }                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ pub struct DiffSummary {                                                                                                                                                                                                                             │
│     pub total_added: usize,                                                                                                                                                                                                                          │
│     pub total_removed: usize,                                                                                                                                                                                                                        │
│     pub total_modified: usize,                                                                                                                                                                                                                       │
│     pub spaces_only_in_a: Vec<String>,                                                                                                                                                                                                               │
│     pub spaces_only_in_b: Vec<String>,                                                                                                                                                                                                               │
│ }                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ pub struct BranchDiffResult {                                                                                                                                                                                                                        │
│     pub branch_a: String,                                                                                                                                                                                                                            │
│     pub branch_b: String,                                                                                                                                                                                                                            │
│     pub spaces: Vec<SpaceDiff>,                                                                                                                                                                                                                      │
│     pub summary: DiffSummary,                                                                                                                                                                                                                        │
│ }                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ Implementation steps:                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                      │
│ 1. Verify both branches exist                                                                                                                                                                                                                        │
│ 2. List spaces in both branches                                                                                                                                                                                                                      │
│ 3. Compute space-level diff: spaces only in A, only in B, in both                                                                                                                                                                                    │
│ 4. For each shared space + all TypeTags:                                                                                                                                                                                                             │
│   - Scan A: build HashMap<(user_key_bytes, TypeTag), (Key, Value)>                                                                                                                                                                                   │
│   - Scan B: same                                                                                                                                                                                                                                     │
│   - Compare: keys only in A → removed, only in B → added, both but different value → modified                                                                                                                                                        │
│ 5. For spaces only in A: all entries are "removed"                                                                                                                                                                                                   │
│ 6. For spaces only in B: all entries are "added"                                                                                                                                                                                                     │
│ 7. Aggregate DiffSummary counts                                                                                                                                                                                                                      │
│ 8. Return BranchDiffResult                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                      │
│ Executor (branches.rs)                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                      │
│ - Replace placeholder BranchDiff struct with re-export of branch_ops::BranchDiffResult                                                                                                                                                               │
│ - diff(&self, branch_a: &str, branch_b: &str) -> Result<BranchDiffResult> calls branch_ops::diff_branches                                                                                                                                            │
│ - Add Strata::diff_branches(branch_a, branch_b) convenience method                                                                                                                                                                                   │
│                                                                                                                                                                                                                                                      │
│ ---                                                                                                                                                                                                                                                  │
│ Phase 3: Merge                                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                                      │
│ Engine (branch_ops.rs)                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                      │
│ pub fn merge_branches(                                                                                                                                                                                                                               │
│     db: &Arc<Database>,                                                                                                                                                                                                                              │
│     source: &str,                                                                                                                                                                                                                                    │
│     target: &str,                                                                                                                                                                                                                                    │
│     strategy: MergeStrategy,                                                                                                                                                                                                                         │
│ ) -> StrataResult<MergeInfo>                                                                                                                                                                                                                         │
│                                                                                                                                                                                                                                                      │
│ New types:                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                      │
│ pub enum MergeStrategy {                                                                                                                                                                                                                             │
│     LastWriterWins,  // source overwrites target on conflict                                                                                                                                                                                         │
│     Strict,          // error if any conflicts exist                                                                                                                                                                                                 │
│ }                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ pub struct ConflictEntry {                                                                                                                                                                                                                           │
│     pub key: String,                                                                                                                                                                                                                                 │
│     pub primitive: PrimitiveType,                                                                                                                                                                                                                    │
│     pub space: String,                                                                                                                                                                                                                               │
│     pub source_value: String,                                                                                                                                                                                                                        │
│     pub target_value: String,                                                                                                                                                                                                                        │
│ }                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ pub struct MergeInfo {                                                                                                                                                                                                                               │
│     pub source: String,                                                                                                                                                                                                                              │
│     pub target: String,                                                                                                                                                                                                                              │
│     pub keys_applied: u64,                                                                                                                                                                                                                           │
│     pub conflicts: Vec<ConflictEntry>,  // empty for LWW, populated for Strict                                                                                                                                                                       │
│     pub spaces_merged: u64,                                                                                                                                                                                                                          │
│ }                                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                      │
│ Implementation steps:                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                      │
│ 1. Compute diff: diff_branches(db, target, source) — target is "A" (base), source is "B" (incoming)                                                                                                                                                  │
│ 2. If Strict and modified entries exist: return error with conflict list (no writes)                                                                                                                                                                 │
│ 3. If LastWriterWins (or Strict with no conflicts):                                                                                                                                                                                                  │
│   - For each SpaceDiff:                                                                                                                                                                                                                              │
│       - Ensure target has the space (register if only in source)                                                                                                                                                                                     │
│     - Apply added entries: copy source keys to target via db.transaction(target_branch_id, |txn| txn.put(...))                                                                                                                                       │
│     - Apply modified entries: overwrite target with source values                                                                                                                                                                                    │
│     - removed entries (in target not source): leave unchanged — merge adds, doesn't delete                                                                                                                                                           │
│ 4. Events: append source events not in target (compare counts, copy new ones)                                                                                                                                                                        │
│ 5. Return MergeInfo with stats                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                                      │
│ ---                                                                                                                                                                                                                                                  │
│ Tests                                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                      │
│ Unit tests (in branch_ops.rs)                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                      │
│ - test_fork_copies_all_data — KV, State, JSON, Event, Vector data all present in fork                                                                                                                                                                │
│ - test_fork_source_not_found — error on non-existent source                                                                                                                                                                                          │
│ - test_fork_destination_exists — error when destination already exists                                                                                                                                                                               │
│ - test_fork_multi_space — fork preserves multiple spaces                                                                                                                                                                                             │
│ - test_fork_source_unchanged — source data unmodified after fork                                                                                                                                                                                     │
│ - test_diff_empty_branches — empty diff when both empty                                                                                                                                                                                              │
│ - test_diff_one_populated — all entries show as added/removed                                                                                                                                                                                        │
│ - test_diff_modifications — detects changed values                                                                                                                                                                                                   │
│ - test_diff_multi_space — per-space diff structure                                                                                                                                                                                                   │
│ - test_merge_lww — last-writer-wins resolves conflicts                                                                                                                                                                                               │
│ - test_merge_strict_no_conflicts — strict succeeds when no conflicts                                                                                                                                                                                 │
│ - test_merge_strict_with_conflicts — strict returns error and conflict list                                                                                                                                                                          │
│ - test_merge_adds_without_deleting — merge doesn't remove target-only keys                                                                                                                                                                           │
│                                                                                                                                                                                                                                                      │
│ Integration tests (update tests/integration/branching.rs)                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                      │
│ - Replace test_branches_fork_not_implemented → test_fork_branch                                                                                                                                                                                      │
│ - Replace test_branches_diff_not_implemented → test_diff_branches                                                                                                                                                                                    │
│ - Add test_merge_branches_lww                                                                                                                                                                                                                        │
│ - Add test_merge_branches_strict                                                                                                                                                                                                                     │
│ - Add test_fork_diff_merge_roundtrip — fork, diverge, diff, merge, verify                                                                                                                                                                            │
│ - Add test_fork_with_spaces — multi-space fork via API                                                                                                                                                                                               │
│ - Add test_diff_with_all_primitives — KV + JSON + Event + State + Vector                                                                                                                                                                             │
│                                                                                                                                                                                                                                                      │
│ ---                                                                                                                                                                                                                                                  │
│ Execution Strategy                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                                      │
│ Run 3 parallel agents:                                                                                                                                                                                                                               │
│ ┌───────┬───────────────────────────────────────────────────────────────────────────────────────┐                                                                                                                                                    │
│ │ Agent │                                         Scope                                         │                                                                                                                                                    │
│ ├───────┼───────────────────────────────────────────────────────────────────────────────────────┤                                                                                                                                                    │
│ │ A     │ crates/engine/src/branch_ops.rs — all three functions + types + unit tests            │                                                                                                                                                    │
│ ├───────┼───────────────────────────────────────────────────────────────────────────────────────┤                                                                                                                                                    │
│ │ B     │ Executor changes: branches.rs (replace stubs), mod.rs (add methods), lib.rs (exports) │                                                                                                                                                    │
│ ├───────┼───────────────────────────────────────────────────────────────────────────────────────┤                                                                                                                                                    │
│ │ C     │ Integration tests in tests/integration/branching.rs                                   │                                                                                                                                                    │
│ └───────┴───────────────────────────────────────────────────────────────────────────────────────┘                                                                                                                                                    │
│ Then: cargo test to verify everything compiles and passes.                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                      │
│ Open Questions (Resolved)                                                                                                                                                                                                                            │
│ ┌─────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐             │
│ │            Question             │                                    Decision                                     │                                                    Rationale                                                     │             │
│ ├─────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤             │
│ │ Merge on active branch?         │ Yes                                                                             │ Operations target named branches, not handles                                                                    │             │
│ ├─────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤             │
│ │ Merge commit event?             │ No for MVP                                                                      │ Events are user data, not metadata. Add later if needed                                                          │             │
│ ├─────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤             │
│ │ Merge deletes target-only keys? │ No                                                                              │ Merge = "bring source changes into target", not "make target identical to source". Use fork for full replacement │             │
│ ├─────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤             │
│ │ fork signature?                 │ fork(source, dest) on Branches, fork_branch(dest) on Strata uses current branch │ Matches roadmap's db.fork_branch("source", "destination") flexibility while keeping convenience                  │             │
│ └─────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘             │
│ Verification                                                                                                                                                                                                                                         │
│                                                                                                                                                                                                                                                      │
│ 1. cargo test — all existing + new tests pass                                                                                                                                                                                                        │
│ 2. cargo clippy — no warnings                                                                                                                                                                                                                        │
│ 3. cargo fmt --check — formatted                                                                                                                                                                                                                     │
│ 4. Manual smoke test: open DB → write data → fork → modify → diff → merge → verify      