//! Error types for command execution.
//!
//! All errors from command execution are represented by the [`Error`] enum.
//! These errors are:
//! - **Structured**: Each variant has typed fields for error details
//! - **Serializable**: Can be converted to/from JSON
//! - **Lossless**: No error information is lost in conversion from internal errors

use serde::{Deserialize, Serialize};

/// Command execution errors.
///
/// All errors that can occur during command execution are represented here.
/// Errors are structured to preserve details for client-side handling.
///
/// # Categories
///
/// | Category | Variants | Description |
/// |----------|----------|-------------|
/// | Not Found | `KeyNotFound`, `BranchNotFound`, etc. | Entity doesn't exist |
/// | Type | `WrongType` | Type mismatch |
/// | Validation | `InvalidKey`, `InvalidPath`, `InvalidInput` | Bad input |
/// | Concurrency | `VersionConflict`, `TransitionFailed`, `Conflict` | Race conditions |
/// | State | `BranchClosed`, `BranchExists`, `CollectionExists` | Invalid state transition |
/// | Constraint | `DimensionMismatch`, `ConstraintViolation`, etc. | Limits exceeded |
/// | Transaction | `TransactionNotActive`, `TransactionAlreadyActive` | Transaction state |
/// | System | `Io`, `Serialization`, `Internal` | Infrastructure errors |
///
/// # Example
///
/// ```text
/// use strata_executor::{Command, Error, Executor};
///
/// match executor.execute(cmd) {
///     Ok(output) => { /* handle success */ }
///     Err(Error::KeyNotFound { key }) => {
///         println!("Key '{}' not found", key);
///     }
///     Err(e) => {
///         println!("Error: {}", e);
///     }
/// }
/// ```
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize, thiserror::Error)]
pub enum Error {
    // ==================== Not Found ====================
    /// Key not found in KV store
    #[error("key not found: {key}")]
    KeyNotFound {
        /// The missing key.
        key: String,
    },

    /// Branch not found
    #[error("branch not found: {branch}")]
    BranchNotFound {
        /// The missing branch identifier.
        branch: String,
    },

    /// Vector collection not found
    #[error("collection not found: {collection}")]
    CollectionNotFound {
        /// The missing collection name.
        collection: String,
    },

    /// Event stream not found
    #[error("stream not found: {stream}")]
    StreamNotFound {
        /// The missing stream name.
        stream: String,
    },

    /// State cell not found
    #[error("cell not found: {cell}")]
    CellNotFound {
        /// The missing cell name.
        cell: String,
    },

    /// JSON document not found
    #[error("document not found: {key}")]
    DocumentNotFound {
        /// The missing document key.
        key: String,
    },

    // ==================== Type Errors ====================
    /// Wrong type for operation
    #[error("wrong type: expected {expected}, got {actual}")]
    WrongType {
        /// Expected type name.
        expected: String,
        /// Actual type name.
        actual: String,
    },

    // ==================== Validation Errors ====================
    /// Invalid key format
    #[error("invalid key: {reason}")]
    InvalidKey {
        /// Reason the key is invalid.
        reason: String,
    },

    /// Invalid JSON path
    #[error("invalid path: {reason}")]
    InvalidPath {
        /// Reason the path is invalid.
        reason: String,
    },

    /// Invalid input
    #[error("invalid input: {reason}")]
    InvalidInput {
        /// Description of the validation failure.
        reason: String,
    },

    // ==================== Concurrency Errors ====================
    /// Version conflict (CAS failure)
    #[error("version conflict: expected {expected_type}:{expected}, got {actual_type}:{actual}")]
    VersionConflict {
        /// Expected version number.
        expected: u64,
        /// Actual version number found.
        actual: u64,
        /// Expected version type label.
        expected_type: String,
        /// Actual version type label.
        actual_type: String,
    },

    /// State transition failed (expected value mismatch)
    #[error("transition failed: expected {expected}, got {actual}")]
    TransitionFailed {
        /// Expected state value.
        expected: String,
        /// Actual state value.
        actual: String,
    },

    /// Generic conflict
    #[error("conflict: {reason}")]
    Conflict {
        /// Description of the conflict.
        reason: String,
    },

    // ==================== State Errors ====================
    /// Branch is closed
    #[error("branch closed: {branch}")]
    BranchClosed {
        /// The closed branch identifier.
        branch: String,
    },

    /// Branch already exists
    #[error("branch already exists: {branch}")]
    BranchExists {
        /// The duplicate branch identifier.
        branch: String,
    },

    /// Collection already exists
    #[error("collection already exists: {collection}")]
    CollectionExists {
        /// The duplicate collection name.
        collection: String,
    },

    // ==================== Constraint Errors ====================
    /// Vector dimension mismatch
    #[error("dimension mismatch: expected {expected}, got {actual}")]
    DimensionMismatch {
        /// Expected dimensionality.
        expected: usize,
        /// Actual dimensionality provided.
        actual: usize,
    },

    /// Constraint violation
    #[error("constraint violation: {reason}")]
    ConstraintViolation {
        /// Description of the violated constraint.
        reason: String,
    },

    /// Requested version was trimmed by retention policy
    #[error("history trimmed: requested version {requested}, earliest is {earliest}")]
    HistoryTrimmed {
        /// Version that was requested.
        requested: u64,
        /// Earliest available version.
        earliest: u64,
    },

    /// Numeric overflow
    #[error("overflow: {reason}")]
    Overflow {
        /// Description of the overflow.
        reason: String,
    },

    // ==================== Access Control ====================
    /// Write command rejected because the database is read-only
    #[error("access denied: {command} rejected â€” database is read-only")]
    AccessDenied {
        /// Name of the rejected command.
        command: String,
    },

    // ==================== Transaction Errors ====================
    /// No active transaction
    #[error("no active transaction")]
    TransactionNotActive,

    /// Transaction already active
    #[error("transaction already active")]
    TransactionAlreadyActive,

    /// Transaction conflict (commit-time validation failure)
    #[error("transaction conflict: {reason}")]
    TransactionConflict {
        /// Description of the transaction conflict.
        reason: String,
    },

    // ==================== System Errors ====================
    /// I/O error
    #[error("I/O error: {reason}")]
    Io {
        /// I/O error details.
        reason: String,
    },

    /// Serialization error
    #[error("serialization error: {reason}")]
    Serialization {
        /// Serialization error details.
        reason: String,
    },

    /// Internal error (bug or invariant violation)
    #[error("internal error: {reason}")]
    Internal {
        /// Internal error details.
        reason: String,
    },

    /// Feature not yet implemented
    #[error("not implemented: {feature} - {reason}")]
    NotImplemented {
        /// Name of the unimplemented feature.
        feature: String,
        /// Details about what is missing.
        reason: String,
    },

    /// The requested timestamp is before the oldest available data
    #[error("history unavailable: requested timestamp {requested_ts} is before oldest available {oldest_available_ts}")]
    HistoryUnavailable {
        /// The timestamp that was requested.
        requested_ts: u64,
        /// The oldest available timestamp.
        oldest_available_ts: u64,
    },
}
